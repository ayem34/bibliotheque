{% extends 'base.html' %}
{% load tz %}
{% block title %}Emprunts{% endblock %}

{% block content %}
<!--  MESSAGES FLASH -->
{% if messages %}
<div class="container-fluid mt-3">
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm" role="alert">
            <i class="fas 
                {% if message.tags == 'success' %}fa-check-circle text-success
                {% elif message.tags == 'error' %}fa-exclamation-triangle text-danger
                {% else %}fa-info-circle text-info{% endif %}
                me-2"></i>
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    {% endfor %}
</div>
{% endif %}

<div class="container mt-5">
    <h3 class="text-center mb-4">
    {% if request.user.role == 'ADMIN' %}
        Gestion des Emprunts
    {% else %}
        Mes Emprunts
    {% endif %}
    </h3>
    <div class="card shadow-lg border-0 rounded-4">
        <div class="card-header bg-gradient-primary text-white text-center py-3">
            <h5><i class="fas fa-hand-holding me-2"></i>Liste des Emprunts</h5>
        </div>

        <div class="card-body">

            <!-- Filtre par statut -->
            <form method="get" class="mb-3 d-flex justify-content-end">
                <select name="statut" class="form-select w-auto me-2">
                    <option value="">-- Tous les statuts --</option>
                    {% for code, label in statut_choices %}
                        <option value="{{ code }}" {% if statut_filter == code %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-primary">Filtrer</button>
            </form>

            <table class="table table-striped table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        {% if request.user.role == 'ADMIN' %}
                            <th>Utilisateur</th>
                        {% endif %}
                        <th>Livre</th>
                        <th>Code Barre</th>
                        <th>Date Demande</th>
                        <th>Date Retour</th>
                        <th class="text-center">Statut</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for e in page_obj %}
                        <tr>
                            {% if request.user.role == 'ADMIN' %}
                                <td>{{ e.utilisateur.username }}</td>
                            {% endif %}
                            <td>{{ e.exemplaire.livre.titre }}</td>
                            <td>{{ e.exemplaire.code_barre }}</td>
                            <td>{{ e.date_demande|date:"d/m/Y H:i" }}</td>

                            <!-- Date retour + indicateurs -->
                            <td>
                                {{ e.date_retour|date:"d/m/Y H:i"|default:"-" }}
                                {% if e.statut == 'VALIDE' and e.date_retour %}
                                    {% if e.date_retour < now %}
                                        <span class="badge bg-danger ms-2">En retard</span>
                                    {% elif e.date_retour < now|add:"172800" %}
                                        <span class="badge bg-warning text-dark ms-2">Rappel</span>
                                    {% endif %}
                                {% endif %}
                            </td>

                            <!-- Statut coloré -->
                            <td class="text-center">
                                {% if e.statut == 'EN_ATTENTE' %}
                                    <span class="badge rounded-pill" style="background-color: #f0ad4e; color: #212529;">
                                        <i class="fas fa-clock me-1"></i> En attente
                                    </span>
                                {% elif e.statut == 'VALIDE' %}
                                    <span class="badge rounded-pill" style="background-color: #28a745; color: #fff;">
                                        <i class="fas fa-check me-1"></i> Validé
                                    </span>
                                {% elif e.statut == 'RENDU' %}
                                    <span class="badge rounded-pill" style="background-color: #6c757d; color: #fff;">
                                        <i class="fas fa-book-reader me-1"></i> Rendu
                                    </span>
                                {% elif e.statut == 'REFUSE' %}
                                    <span class="badge rounded-pill" style="background-color: #dc3545; color: #fff;">
                                        <i class="fas fa-ban me-1"></i> Refusé
                                    </span>
                                {% elif e.statut == 'ANNULE' %}
                                    <span class="badge rounded-pill" style="background-color: #17a2b8; color: #fff;">
                                        <i class="fas fa-times-circle me-1"></i> Annulé
                                    </span>
                                {% endif %}
                            </td>

                            <!-- Actions -->
                            <td class="text-center">
                                {% if request.user.role == 'ADMIN' %}
                                    {% if e.statut == 'EN_ATTENTE' or e.statut == 'VALIDE' %}
                                        <a href="{% url 'modifier_emprunt' e.id %}" class="btn btn-sm btn-outline-primary me-1" title="Modifier">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    {% endif %}
                                    {% if e.statut == 'EN_ATTENTE' %}
                                        <a href="{% url 'refuser_emprunt' e.id %}" class="btn btn-sm btn-outline-danger" title="Refuser l'emprunt">
                                            <i class="fas fa-ban"></i>
                                        </a>
                                    {% endif %}
                                {% else %}
                                    {% if e.statut == 'EN_ATTENTE' %}
                                        <a href="{% url 'annuler_emprunt' e.id %}" class="btn btn-sm btn-outline-danger me-1" title="Annuler l'emprunt">
                                            <i class="fas fa-times-circle"></i> Annuler
                                        </a>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="{% if request.user.role == 'ADMIN' %}7{% else %}6{% endif %}" class="text-center">
                                Aucun emprunt trouvé.
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Pagination -->
            <nav aria-label="Pagination">
                <ul class="pagination justify-content-center mt-3">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if statut_filter %}&statut={{ statut_filter }}{% endif %}" aria-label="Précédent">&laquo;</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                        {% else %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}{% if statut_filter %}&statut={{ statut_filter }}{% endif %}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if statut_filter %}&statut={{ statut_filter }}{% endif %}" aria-label="Suivant">&raquo;</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                    {% endif %}
                </ul>
            </nav>

            <!-- Bouton pour demander un emprunt -->
            {% if request.user.role != 'ADMIN' %}
                <a href="{% url 'demander_emprunt' %}" class="btn btn-success w-100 mt-3 rounded-pill shadow-sm">
                    <i class="fas fa-plus-circle me-2"></i> Demander un emprunt
                </a>
            {% endif %}

        </div>
    </div>
</div>
{% endblock %}